name: CI Pipeline

on:
  push:
    branches: [ main, develop, '*', feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run full tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  # Determine what type of tests to run
  test-config:
    runs-on: ubuntu-latest
    outputs:
      test-mode: ${{ steps.config.outputs.test-mode }}
      run-security: ${{ steps.config.outputs.run-security }}
      run-docker: ${{ steps.config.outputs.run-docker }}
      cache-key: ${{ steps.config.outputs.cache-key }}

    steps:
    - name: Configure test strategy
      id: config
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "test-mode=full" >> $GITHUB_OUTPUT
          echo "run-security=true" >> $GITHUB_OUTPUT
          echo "run-docker=true" >> $GITHUB_OUTPUT
          echo "cache-key=full" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
          echo "test-mode=full" >> $GITHUB_OUTPUT
          echo "run-security=false" >> $GITHUB_OUTPUT
          echo "run-docker=false" >> $GITHUB_OUTPUT
          echo "cache-key=full" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "test-mode=fast" >> $GITHUB_OUTPUT
          echo "run-security=false" >> $GITHUB_OUTPUT
          echo "run-docker=false" >> $GITHUB_OUTPUT
          echo "cache-key=fast" >> $GITHUB_OUTPUT
        else
          echo "test-mode=quick" >> $GITHUB_OUTPUT
          echo "run-security=false" >> $GITHUB_OUTPUT
          echo "run-docker=false" >> $GITHUB_OUTPUT
          echo "cache-key=quick" >> $GITHUB_OUTPUT
        fi

  # Main test job with conditional execution
  test:
    runs-on: ubuntu-latest
    needs: test-config
    strategy:
      matrix:
        python-version: [3.11]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ needs.test-config.outputs.cache-key }}-${{ hashFiles('pocket-cm/**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ needs.test-config.outputs.cache-key }}-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libmagic1 libmagic-dev
        python -m pip install --upgrade pip
        pip install -r pocket-cm/requirements.txt

    # Conditional test execution based on mode
    - name: Run Quick Tests
      if: needs.test-config.outputs.test-mode == 'quick'
      run: |
        cd pocket-cm
        pytest tests/test_pydantic_validation.py -v --tb=short

    - name: Run Fast Tests
      if: needs.test-config.outputs.test-mode == 'fast'
      run: |
        cd pocket-cm
        pytest tests/test_pydantic_validation.py tests/test_security.py -v --tb=short

    - name: Run Full Tests with Coverage
      if: needs.test-config.outputs.test-mode == 'full'
      run: |
        cd pocket-cm
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=html --cov-report=term-missing

    # Linting (run for all modes except quick)
    - name: Run Linting
      if: needs.test-config.outputs.test-mode != 'quick'
      run: |
        pip install ruff
        cd pocket-cm
        ruff check src/ ${{ needs.test-config.outputs.test-mode == 'full' && 'tests/' || '' }} --output-format=github

    # Type checking (full mode only)
    - name: Run Type Checking
      if: needs.test-config.outputs.test-mode == 'full'
      run: |
        pip install mypy types-python-magic
        cd pocket-cm
        mypy src/ --ignore-missing-imports --no-error-summary

    # Coverage upload (full mode only)
    - name: Upload Coverage to Codecov
      if: needs.test-config.outputs.test-mode == 'full' && matrix.python-version == '3.11'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Archive Coverage Report
      if: needs.test-config.outputs.test-mode == 'full'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ matrix.python-version }}
        path: htmlcov/

  # Security scan (main branch only)
  security:
    runs-on: ubuntu-latest
    needs: test-config
    if: needs.test-config.outputs.run-security == 'true'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit

    - name: Check for security vulnerabilities
      run: |
        safety check --json || true
        cd pocket-cm
        bandit -r src/ -f json || true

  # Docker test (main branch only)
  docker-test:
    runs-on: ubuntu-latest
    needs: [test-config, test]
    if: needs.test-config.outputs.run-docker == 'true'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: pocket-cm
        push: false
        load: true
        tags: pocket-cm:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image
      run: |
        docker run --rm -d -p 8000:8000 --name test-container pocket-cm:test
        sleep 10
        curl -f http://localhost:8000/health || exit 1
        docker stop test-container